<!DOCTYPE html>
<html lang="en">
<script>
    const urlParams = new URLSearchParams(window.location.search);

    var office = urlParams.get('office') || 'MVS';
    console.log('office: ', office);

    // Get the value of a specific parameter
    var cda = urlParams.get('cda');
    console.log('cda: ', cda);

    // Calculate the document root
    const documentRoot = window.location.protocol + "//" + window.location.host + "/";
    console.log("documentRoot: ", documentRoot);

    // Determine the default value of cda based on documentRoot
    if (documentRoot === `https://wm.${office.toLocaleLowerCase()}.ds.usace.army.mil/` || `http://localhost:5173/` || `https://wm.rsgis.dev/` || `https://wm-${office.toLocaleLowerCase()}coop.mvk.ds.usace.army.mil/`) {
        cdaDefault = "internal";
    } else if (documentRoot === `https://wm-${office.toLocaleLowerCase()}coop.mvk.ds.usace.army.mil/`) {
        cdaDefault = "internal-coop";
    } else {
        cdaDefault = "public";
    }
    console.log("cdaDefault: ", cdaDefault);

    if (cda === null) {
        cda = cdaDefault;
    }
    console.log("cda: ", cda);

    var type = urlParams.get('type') || null;
    console.log('type: ', type);

    var lake = urlParams.get('lake') || 'Lk Shelbyville';
    console.log('lake: ', lake);

    var datetime = urlParams.get('datetime') || formatDate(new Date());
    console.log('datetime: ', datetime);

    function formatDate(date) {
        let month = String(date.getMonth() + 1).padStart(2, '0'); // Ensure two-digit month
        let day = String(date.getDate()).padStart(2, '0'); // Ensure two-digit day
        let year = date.getFullYear();
        return `${month}-${day}-${year}`;
    }
</script>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Sheet</title>
    <meta name="Description" content="U.S. Army Corps of Engineers St. Louis District Home Page" />
    <link rel="stylesheet" href="css/body.css" />
    <link rel="stylesheet" href="css/breadcrumbs.css" />
    <link rel="stylesheet" href="css/jumpMenu.css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="js/main.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/moment-timezone-with-data.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/chartjs-adapter-moment.min.js"></script>
    <style>
        #container {
            display: flex;
            justify-content: center;
            /* Center horizontally */
            align-items: center;
            /* Center vertically */
            /* height: 10vh; */
            /* Full viewport height */
            margin-bottom: 15px;
        }

        table {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: center;
        }

        td {
            border: 1px solid black;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="page-container">
        <header id="header">
            <!--Header content populated here by JavaScript Tag at end of body -->
        </header>
        <div class="page-wrap">
            <div class="container-fluid">
                <div id="breadcrumbs">
                </div>
                <div class="page-content">
                    <sidebar id="sidebar"></sidebar>
                    <div id="topPane" class="col-md backend-cp-collapsible">
                        <div class="box-usace">
                            <h2 class="box-header-striped">
                                <span class="titleLabel title"></span>
                                <span class="rss"></span>
                            </h2>
                            <div class="box-content" style="background-color:white;margin:auto">
                                <div class="content">
                                    <div id="loading" style="display: none;"><img
                                            src="https://wm.mvs.ds.usace.army.mil/apps/alarms/images/loading4.gif"
                                            style='height: 50px; width: 50px;' alt="Loading..." /></div>
                                    <div id="container"></div>
                                    <script>
                                        let setBaseUrl = null;
                                        if (cda === "internal") {
                                            setBaseUrl = `https://wm.${office.toLowerCase()}.ds.usace.army.mil:8243/${office.toLowerCase()}-data/`;
                                        } else if (cda === "internal-coop") {
                                            setBaseUrl = `https://wm-${office.toLowerCase()}coop.mvk.ds.usace.army.mil:8243/${office.toLowerCase()}-data/`;
                                        } else if (cda === "public") {
                                            setBaseUrl = `https://cwms-data.usace.army.mil/cwms-data/`;
                                        }
                                        console.log("setBaseUrl: ", setBaseUrl);

                                        const loadingIndicator = document.getElementById(`loading`);
                                        loadingIndicator.style.display = 'block';

                                        let setLocationCategory = "Lakes";
                                        let setLocationGroupOwner = "Project";

                                        const basinCategoryApiUrl = `${setBaseUrl}location/group?office=${office}&include-assigned=false&location-category-like=${setLocationCategory}`;
                                        console.log("basinCategoryApiUrl: ", basinCategoryApiUrl);

                                        let apiPromises = [];
                                        let combinedData = [];

                                        // Initial category fetch
                                        fetch(basinCategoryApiUrl)
                                            .then(response => {
                                                if (!response.ok) throw new Error('Network response was not ok');
                                                return response.json();
                                            })
                                            .then(data => {
                                                if (!Array.isArray(data) || data.length === 0) {
                                                    console.warn('No data available from the initial fetch.');
                                                    return;
                                                }

                                                const targetCategory = { "office-id": office, "id": setLocationCategory };
                                                const filteredArray = filterByLocationCategory(data, targetCategory);
                                                let basins = filteredArray.map(item => item.id);

                                                if (basins.length === 0) {
                                                    console.warn('No basins found for the given category.');
                                                    return;
                                                }

                                                // Loop through each basin and fetch assigned locations
                                                basins.forEach(basin => {
                                                    const basinGroupLocationApiUrl = `${setBaseUrl}location/group/${basin}?office=${office}&category-id=${setLocationCategory}`;
                                                    console.log("basinGroupLocationApiUrl: ", basinGroupLocationApiUrl);

                                                    apiPromises.push(
                                                        fetch(basinGroupLocationApiUrl)
                                                            .then(response => {
                                                                if (!response.ok) throw new Error(`Network response was not ok for basin ${basin}`);
                                                                return response.json();
                                                            })
                                                            .then(getBasin => {
                                                                if (!getBasin || !getBasin['assigned-locations']) {
                                                                    console.warn(`No assigned locations for basin ${basin}`);
                                                                    return;
                                                                }

                                                                // Filter locations with attribute <= 900
                                                                getBasin['assigned-locations'] = getBasin['assigned-locations'].filter(
                                                                    location => location.attribute <= 900
                                                                );

                                                                // Sort the locations by their attribute
                                                                getBasin['assigned-locations'].sort((a, b) => a.attribute - b.attribute);

                                                                combinedData.push(getBasin);
                                                            })
                                                            .catch(error => console.error(`Problem with the fetch operation for basin ${basin}:`, error))
                                                    );
                                                });

                                                return Promise.all(apiPromises);
                                            })
                                            .then(() => {
                                                console.log('All combinedData fetched and filtered successfully:', combinedData);
                                                loadingIndicator.style.display = 'none';

                                                // Call createTable once all data is processed
                                                createTable(combinedData);
                                            })
                                            .catch(error => {
                                                console.error('There was a problem with the initial fetch operation:', error);
                                                loadingIndicator.style.display = 'none';
                                            });

                                        function createTable(data) {
                                            if (!Array.isArray(data)) {
                                                console.error("combinedData is not an array!", data);
                                                return;
                                            }

                                            const container = document.getElementById("container");
                                            if (!container) return;

                                            const table = document.createElement("table");
                                            table.border = "1";

                                            const row = document.createElement("tr");

                                            data.forEach(item => {
                                                item["assigned-locations"].forEach(location => {
                                                    const cell = document.createElement("td");

                                                    // Extract part before the dash
                                                    const locationName = location["location-id"].split("-")[0].trim();
                                                    const locationId = location["location-id"];

                                                    // Create link
                                                    const link = document.createElement("a");
                                                    link.href = `https://wm.mvs.ds.usace.army.mil/mvs/lake/index.html?office=MVS&lake=${encodeURIComponent(locationId)}`;
                                                    link.textContent = locationName;
                                                    // link.target = "_blank"; // Opens in a new tab

                                                    cell.appendChild(link);
                                                    row.appendChild(cell);
                                                });
                                            });

                                            table.appendChild(row);
                                            container.appendChild(table);
                                        }

                                        function filterByLocationCategory(array, setLocationCategory) {
                                            return array.filter(item =>
                                                item['location-category'] &&
                                                item['location-category']['office-id'] === setLocationCategory['office-id'] &&
                                                item['location-category']['id'] === setLocationCategory['id']
                                            );
                                        }

                                        function fetchAdditionalLocationGroupOwnerData(locationId, setBaseUrl, setLocationGroupOwner, office) {
                                            // Construct the URL
                                            const additionalDataUrl = `${setBaseUrl}location/group/${setLocationGroupOwner}?office=${office}&category-id=${office}`;

                                            return fetch(additionalDataUrl, {
                                                method: 'GET'
                                            })
                                                .then(response => {
                                                    // If response is not OK, log the status and return null
                                                    if (!response.ok) {
                                                        console.warn(`Response not ok for ${locationId}: Status ${response.status}`);
                                                        return null;
                                                    }
                                                    return response.json();
                                                })
                                                .then(data => {
                                                    // If data is not null, log the fetched data
                                                    if (data) {
                                                        // console.log(`Fetched additional data for ${locationId}:`, data);
                                                    }
                                                    return data;
                                                })
                                                .catch(error => {
                                                    // Catch any errors and log them
                                                    console.error(`Error fetching additional data for ${locationId}:`, error);
                                                    return null; // Return null in case of error
                                                });
                                        }
                                    </script>

                                    <div class="widgets-container">
                                        <div class="widget full-width" id="widget1">
                                            <h3>Widget 1: Upstream</h3>
                                            <button class="save-btn" onclick="saveData(1)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(1)">Fetch Data</button>
                                            <div class="output" id="output1"></div>
                                        </div>

                                        <div class="widget full-width" id="widget2">
                                            <h3>Widget 2: Pool</h3>
                                            <button class="save-btn" onclick="saveData(2)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(2)">Fetch Data</button>
                                            <div class="output" id="output2"></div>
                                        </div>

                                        <div class="widget full-width" id="widget3">
                                            <h3>Widget 3: Regulation Pool (Optional)</h3>
                                            <button class="save-btn" onclick="saveData(3)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(3)">Fetch Data</button>
                                            <div class="output" id="output3"></div>
                                        </div>

                                        <div class="widget half-width" id="widget4">
                                            <h3>Widget 4: Gate Settings</h3>
                                            <button class="save-btn" onclick="saveData(4)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(4)">Fetch Data</button>
                                            <div class="output" id="output4"></div>
                                        </div>

                                        <div class="widget half-width" id="widget5">
                                            <h3>Widget 5: Inflow</h3>
                                            <button class="save-btn" onclick="saveData(5)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(5)">Fetch Data</button>
                                            <div class="output" id="output5"></div>
                                        </div>

                                        <div class="widget half-width" id="widget6">
                                            <h3>Widget 6: Forecast</h3>
                                            <button class="save-btn" onclick="saveData(6)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(6)">Fetch Data</button>
                                            <div class="output" id="output6"></div>
                                        </div>

                                        <div class="widget half-width" id="widget7">
                                            <h3>Widget 7: Balance Window</h3>
                                            <button class="save-btn" onclick="saveData(7)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(7)">Fetch Data</button>
                                            <div class="output" id="output7"></div>
                                        </div>

                                        <div class="widget half-width" id="widget8">
                                            <h3>Widget 8: Lake Office 24-hour Precipitation</h3>
                                            <button class="save-btn" onclick="saveData(8)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(8)">Fetch Data</button>
                                            <div class="output" id="output8"></div>
                                        </div>

                                        <div class="widget half-width" id="widget9">
                                            <h3>Widget 9: Rule Curve (Stage29)</h3>
                                            <button class="save-btn" onclick="saveData(9)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(9)">Fetch Data</button>
                                            <div class="output" id="output9"></div>
                                        </div>

                                        <div class="widget half-width" id="widget10">
                                            <h3>Widget 10: Crest Forecast</h3>
                                            <button class="save-btn" onclick="saveData(10)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(10)">Fetch Data</button>
                                            <div class="output" id="output10"></div>
                                        </div>

                                        <div class="widget half-width" id="widget11">
                                            <h3>Widget 11: Notes</h3>
                                            <button class="save-btn" onclick="saveData(11)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(11)">Fetch Data</button>
                                            <div class="output" id="output11"></div>
                                        </div>

                                        <!-- Updated Widget 12 and Widget 13 to half-width -->
                                        <div class="widget half-width" id="widget12">
                                            <h3>Widget 12: Generation and Release (Optional)</h3>
                                            <button class="save-btn" onclick="saveData(12)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(12)">Fetch Data</button>
                                            <div class="output" id="output12"></div>
                                        </div>

                                        <div class="widget half-width" id="widget13">
                                            <h3>Widget 13: Release Schedule and Instruction (Optional)</h3>
                                            <button class="save-btn" onclick="saveData(13)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(13)">Fetch Data</button>
                                            <div class="output" id="output13"></div>
                                        </div>

                                        <!-- Adding Widget 14 and Widget 15 as full-width -->
                                        <div class="widget full-width" id="widget14">
                                            <h3>Widget 14: TW</h3>
                                            <button class="save-btn" onclick="saveData(14)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(14)">Fetch Data</button>
                                            <div class="output" id="output14"></div>
                                        </div>

                                        <div class="widget full-width" id="widget15">
                                            <h3>Widget 15: Downstream</h3>
                                            <button class="save-btn" onclick="saveData(15)">Save</button>
                                            <button class="fetch-btn" onclick="fetchData(15)">Fetch Data</button>
                                            <div class="output" id="output15"></div>
                                        </div>
                                    </div>


                                    <script src='lake.js'></script>
                                    <script src='widget_01/widget_01.js'></script>
                                    <script src='widget_02/widget_02.js'></script>
                                    <script src='widget_03/widget_03.js'></script>
                                    <script src='widget_04/widget_04.js'></script>
                                    <script src='widget_05/widget_05.js'></script>
                                    <script src='widget_06/widget_06.js'></script>
                                    <script src='widget_07/widget_07.js'></script>
                                    <script src='widget_08/widget_08.js'></script>
                                    <script src='widget_09/widget_09.js'></script>
                                    <script src='widget_10/widget_10.js'></script>
                                    <script src='widget_11/widget_11.js'></script>
                                    <script src='widget_12/widget_12.js'></script>
                                    <script src='widget_13/widget_13.js'></script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="returnTop" title="Return to Top of Page">Top</button>
        </div>
    </div>
    <footer id="footer">
        <!--Footer content populated here by script tag at end of body -->
    </footer>
    <script src="js/libraries/jQuery-3.3.6.min.js"></script>
    <script defer>
        // When the document has loaded pull in the page header and footer skins
        $(document).ready(function () {
            $('#header').load('templates/DISTRICT.header.html');
            $('#footer').load('templates/DISTRICT.footer.html');
        })
    </script>
</body>

</html>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        if (lake !== null && datetime !== null) {
            const titleSpan = document.querySelector('.titleLabel.title');
            const headerTitle = document.querySelector('header .title');

            if (titleSpan) {
                titleSpan.textContent = `${lake.split("-")[0].trim()} - ${datetime}`;
            }

            // Set the title in the header
            if (headerTitle) {
                headerTitle.textContent = `${lake.split("-")[0].trim()} - ${datetime}`;
            }
        }
    });
</script>